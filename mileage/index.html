<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fuel Usage Tracker</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { background-color: #000; color: #fff; }
    .btn-primary { background-color: #007bff; border-color: #007bff; }
    .btn-primary:hover { background-color: #0056b3; }
    input[readonly] { background-color: #444; }
  </style>
</head>
<body class="p-3">

  <!-- üîê Login Section -->
  <div id="loginSection" class="text-center">
    <h2>Login to Fuel Usage Tracker</h2>
    <div id="g_id_onload"
      data-client_id="837033230141-1vrh4l4rukhbldh4gvmc2dufhpjkgpp9.apps.googleusercontent.com"
      data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
  </div>

  <!-- App Container (hidden until login success) -->
  <div class="container" style="display:none;">
    <h1 class="text-center mb-4">
      <img src="logo-512.png" alt="Fuel Icon" style="width:40px; height:40px; vertical-align:middle; margin-right:10px;">
      Fuel Usage Tracker
    </h1>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3" id="fuelTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="entries-tab" data-bs-toggle="tab" data-bs-target="#entries" type="button" role="tab">Entries</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reporting-tab" data-bs-toggle="tab" data-bs-target="#reporting" type="button" role="tab">Reporting</button>
      </li>
    </ul>

    <div class="tab-content" id="fuelTabsContent">
      <!-- Entries Tab -->
      <div class="tab-pane fade show active" id="entries" role="tabpanel">
        <!-- Form -->
        <form id="entryForm" class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" name="Date" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Odometer</label>
            <input type="number" name="Odometer" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Liters</label>
            <input type="number" step="0.01" name="Liters" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Fuel Price</label>
            <input type="number" step="0.01" name="FuelPrice" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="Notes" class="form-control">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Add Entry</button>
          </div>
        </form>
<div id="loading" class="text-center my-3">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

        <!-- Table -->
        <table class="table table-dark table-striped" id="entriesTable">
          <thead>
            <tr>
              <th>Date</th><th>Odometer</th><th>Liters</th><th>Fuel Price</th>
              <th>Mileage</th><th>Cost/KM</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Reporting Tab -->
      <div class="tab-pane fade" id="reporting" role="tabpanel">
        <h3 class="mt-3">Reports</h3>
        <div class="row text-center mb-4" id="reportSummary">
  <div class="col-md-4">
    <div class="card bg-dark text-white shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Avg Mileage</h5>
        <p class="card-text fs-4" id="avgMileage">--</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-dark text-white shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Total Fuel Cost</h5>
        <p class="card-text fs-4" id="totalCost">--</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card bg-dark text-white shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Total Liters</h5>
        <p class="card-text fs-4" id="totalLiters">--</p>
      </div>
    </div>
  </div>
</div>

        <canvas id="fuelChart" height="100"></canvas>
      </div>
    </div>
  </div>

<script>
const API_URL = "https://fuel-proxy.surajts05.workers.dev"; // Cloudflare proxy
let chartInstance = null; // keep track of chart
// ---------- Google Auth gating ----------
const allowedEmails = ["surajts05@gmail.com"]; // <- REPLACE with your email(s), e.g. ["me@gmail.com","friend@gmail.com"]

function handleCredentialResponse(response) {
  try {
    // decode the ID token payload (base64)
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    console.log("üë§ Google user:", payload);

    // check allowed emails
    if (!allowedEmails.includes(payload.email)) {
      alert("‚õî Access denied: unauthorized user (" + payload.email + ")");
      return;
    }

    // success: hide login block and show app container
    document.getElementById("loginSection").style.display = "none";
    document.querySelector(".container").style.display = "block";

    // load data now that user is authenticated
    loadData();
  } catch (err) {
    console.error("Auth handling error:", err);
    alert("Authentication failed. See console for details.");
  }
}
  
// ---------- Initialize Google Identity ----------
window.onload = function () {
  google.accounts.id.initialize({
    client_id: "YOUR_CLIENT_ID.apps.googleusercontent.com", // replace with your client ID
    callback: handleCredentialResponse,
    auto_select: true  // üëà this enables auto sign-in after refresh
  });

  google.accounts.id.renderButton(
    document.getElementById("loginButton"),
    { theme: "outline", size: "large" }
  );

  google.accounts.id.prompt(); // shows the One Tap / auto login
};

// ---------------------------------------

// Handle form submission
document.getElementById('entryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  if (!formData.ID) {
    formData.ID = "FUEL-" + Date.now(); // auto-generate ID
  }

  console.log("üöÄ Sending data to backend:", formData);

  try {
    const response = await fetch(`${API_URL}/entry`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const result = await response.json();
    console.log("üì• Server response:", result);

    if (result.debug) {
      console.group("üõ†Ô∏è Backend Debug Log");
      result.debug.forEach(msg => console.log(msg));
      console.groupEnd();
    }

    if (result.status === "success") {
      e.target.reset();
      loadData(); // reload table
    } else {
      alert("‚ö†Ô∏è Failed to save: " + (result.message || "Unknown error"));
    }

  } catch (err) {
    console.error("‚ùå Submit error:", err);
    alert("‚ö†Ô∏è Network or server error");
  }
});

// Load data for table (always) and optionally chart

async function loadData() {
  try {
    document.getElementById("loading").style.display = "block";
    const response = await fetch(`${API_URL}/entries`);
    const raw = await response.text();   // <-- get raw text
    console.log("üì• Raw backend response:", raw);

    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      console.error("‚ùå JSON parse failed:", e);
      return;
    }

    document.getElementById("loading").style.display = "none";

    if (data.status === "error") {
      console.error("‚ùå Backend error:", data.message);
      return;
    }

    // Handle wrapped response
    const entries = Array.isArray(data) ? data : data.entries || [];
    renderTable(entries);

    if (document.querySelector("#reporting").classList.contains("active")) {
      renderChart(entries);
    } else {
      window.cachedEntries = entries;
    }

  } catch (err) {
    document.getElementById("loading").style.display = "none";
    console.error("‚ùå loadData error:", err);
  }
}


function renderTable(entries) {
  const tbody = document.querySelector("#entriesTable tbody");
  tbody.innerHTML = "";
  entries.forEach(entry => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.Date || ""}</td>
      <td>${entry.Odometer || ""}</td>
      <td>${entry.Liters || ""}</td>
      <td>${entry.FuelPrice || ""}</td>
      <td>${entry.Mileage || ""}</td>
      <td>${entry.CostPerKM || ""}</td>
      <td>${entry.Notes || ""}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteEntry('${entry.ID}')">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderChart(entries) {
  const ctx = document.getElementById("fuelChart").getContext("2d");

  if (chartInstance) {
    chartInstance.destroy();
  }

  const labels = entries.map(e => e.Date);
  const mileage = entries.map(e => Number(e.Mileage) || 0);
  const fuelPrice = entries.map(e => Number(e.FuelPrice) || 0);
  const costPerKM = entries.map(e => Number(e.CostPerKM) || 0);

  // --- Summary calculations ---
  const avgMileage = (mileage.reduce((a, b) => a + b, 0) / mileage.length).toFixed(2);
  const totalCost = fuelPrice.reduce((a, b, i) => a + b * (entries[i].Liters || 0), 0).toFixed(2);
  const totalLiters = entries.reduce((a, e) => a + (Number(e.Liters) || 0), 0).toFixed(2);

  // --- Update summary cards ---
  document.getElementById("avgMileage").innerText = avgMileage + " KM/L";
  document.getElementById("totalCost").innerText = "‚Çπ " + totalCost;
  document.getElementById("totalLiters").innerText = totalLiters + " L";

  // --- Chart rendering ---
  chartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Mileage (KM/L)",
          data: mileage,
          borderColor: "blue",
          backgroundColor: "rgba(0, 123, 255, 0.3)",
          yAxisID: "y1"
        },
        {
          label: "Fuel Price",
          data: fuelPrice,
          borderColor: "green",
          backgroundColor: "rgba(0, 200, 83, 0.3)",
          yAxisID: "y2"
        },
        {
          label: "Cost per KM",
          data: costPerKM,
          type: "bar",
          backgroundColor: "rgba(255, 99, 132, 0.4)",
          borderColor: "rgba(255, 99, 132, 1)",
          yAxisID: "y2"
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      plugins: {
        title: { display: true, text: "Fuel Usage Reporting" }
      },
      scales: {
        y1: {
          type: "linear",
          display: true,
          position: "left",
          title: { display: true, text: "Mileage (KM/L)" }
        },
        y2: {
          type: "linear",
          display: true,
          position: "right",
          grid: { drawOnChartArea: false },
          title: { display: true, text: "‚Çπ / Cost" }
        }
      }
    }
  });
}


// Handle Reporting tab activation
document.getElementById("reporting-tab").addEventListener("shown.bs.tab", () => {
  if (window.cachedEntries) {
    renderChart(window.cachedEntries);
  } else {
    loadData();
  }
});

async function deleteEntry(id) {
  if (!confirm("Delete this entry?")) return;
  try {
    const response = await fetch(`${API_URL}/entry`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    });
    const result = await response.json();
    console.log("üóëÔ∏è Delete response:", result);

    if (result.status === "success") {
      loadData();
    } else {
      alert("‚ö†Ô∏è Delete failed: " + (result.message || "Unknown error"));
    }
  } catch (err) {
    console.error("‚ùå Delete error:", err);
  }
}


// Initial load (after DOM ready)
document.addEventListener("DOMContentLoaded", () => {
  loadData();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


