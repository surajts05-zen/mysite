<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fuel Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center">⛽ Fuel Tracker</h2>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="tabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#log">Log</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#reports" id="reports-tab">Reports</a>
    </li>
  </ul>

  <div class="tab-content pt-3">
    <!-- Log Tab -->
    <div class="tab-pane fade show active" id="log">
      <div class="mb-3">
        <button class="btn btn-primary" onclick="showForm()">+ Add Entry</button>
      </div>
      <table class="table table-bordered table-striped" id="fuelTable">
        <thead class="table-dark">
          <tr>
            <th>Date</th>
            <th>Odometer</th>
            <th>Liters</th>
            <th>Cost</th>
            <th>Mileage</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reports">
      <div class="row text-center mb-4" id="summaryStats">
        <div class="col-12 col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>Total Liters</h6>
              <p class="fs-4 fw-bold" id="totalLiters">--</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>Total Cost</h6>
              <p class="fs-4 fw-bold" id="totalCost">--</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>Avg Mileage</h6>
              <p class="fs-4 fw-bold" id="avgMileage">--</p>
            </div>
          </div>
        </div>
      </div>

      <canvas id="mileageChart" height="100"></canvas>
      <hr>
      <canvas id="costChart" height="100"></canvas>
    </div>
  </div>
</div>

<!-- Modal Form -->
<div class="modal fade" id="entryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Fuel Entry</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="entryForm">
          <input type="hidden" id="rowIndex">
          <div class="mb-3">
            <label>Date</label>
            <input type="date" id="date" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Odometer</label>
            <input type="number" id="odometer" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Liters</label>
            <input type="number" step="0.01" id="liters" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Cost</label>
            <input type="number" step="0.01" id="cost" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Mileage</label>
            <input type="number" step="0.01" id="mileage" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveRow()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwbTs9FagnCKRlgZhaqMWHT25I7xfLJok9Cl_3ryOoS7u-_Bu3sXkOrxHaKhqz_DEQ/exec""; // <-- replace with your Apps Script web app URL
let allRows = [];

async function api(method, payload = {}) {
  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ method, ...payload }),
    headers: { "Content-Type": "application/json" }
  });
  return res.json();
}

async function fetchData() {
  const res = await api("read", {});
  allRows = res.rows;
  renderTable(allRows);

  // update summary cards
  document.getElementById("totalLiters").textContent = res.aggregates.totalLiters.toFixed(1) + " L";
  document.getElementById("totalCost").textContent = "₹" + res.aggregates.totalCost.toFixed(2);
  document.getElementById("avgMileage").textContent = res.aggregates.avgMileage.toFixed(1) + " km/L";

  drawCharts(allRows);
}

function renderTable(rows) {
  const tbody = document.querySelector("#fuelTable tbody");
  tbody.innerHTML = "";
  rows.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row[0]}</td>
      <td>${row[1]}</td>
      <td>${row[2]}</td>
      <td>${row[3]}</td>
      <td>${row[4]}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="editRow(${i+2})">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRow(${i+2})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function showForm() {
  document.getElementById("rowIndex").value = "";
  document.getElementById("entryForm").reset();
  new bootstrap.Modal(document.getElementById("entryModal")).show();
}

async function saveRow() {
  const row = document.getElementById("rowIndex").value;
  const values = [
    document.getElementById("date").value,
    document.getElementById("odometer").value,
    document.getElementById("liters").value,
    document.getElementById("cost").value,
    document.getElementById("mileage").value,
  ];

  if (row) {
    await api("update", { row: parseInt(row), values });
  } else {
    await api("create", { values });
  }

  bootstrap.Modal.getInstance(document.getElementById("entryModal")).hide();
  fetchData();
}

function editRow(rowIndex) {
  const row = allRows[rowIndex-2]; // adjust for header
  document.getElementById("rowIndex").value = rowIndex;
  document.getElementById("date").value = row[0];
  document.getElementById("odometer").value = row[1];
  document.getElementById("liters").value = row[2];
  document.getElementById("cost").value = row[3];
  document.getElementById("mileage").value = row[4];
  new bootstrap.Modal(document.getElementById("entryModal")).show();
}

async function deleteRow(rowIndex) {
  if (confirm("Delete this entry?")) {
    await api("delete", { row: rowIndex });
    fetchData();
  }
}

function drawCharts(rows) {
  const labels = rows.map(r => r[0]);
  const mileage = rows.map(r => r[4]);
  const cost = rows.map(r => r[3]);

  new Chart(document.getElementById("mileageChart"), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: "Mileage (km/L)",
        data: mileage,
        borderColor: "blue",
        borderWidth: 2,
        fill: false
      }]
    }
  });

  new Chart(document.getElementById("costChart"), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: "Cost (₹)",
        data: cost,
        backgroundColor: "orange"
      }]
    }
  });
}

// Load initial data
fetchData();
</script>
</body>
</html>

