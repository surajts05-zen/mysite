<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fuel Tracker</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 12px; }
    canvas { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="text-center mb-4">â›½ Fuel Tracker</h2>
    
    <!-- Input Form -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Add Refill</h5>
        <form id="fuelForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Odometer (km)</label>
            <input type="number" name="odometer" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Liters</label>
            <input type="number" step="0.01" name="liters" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Price/L</label>
            <input type="number" step="0.01" name="price" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Station</label>
            <input type="text" name="station" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary w-100">Save Entry</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="fuelTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">ðŸ“‹ Fuel Logs</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">ðŸ“Š Reports</button>
      </li>
    </ul>

    <div class="tab-content" id="fuelTabsContent">
      <!-- Logs Tab -->
      <div class="tab-pane fade show active" id="logs" role="tabpanel">
        <div id="logsList" class="row"></div>
      </div>

      <!-- Reports Tab -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
        <div class="row">
          <div class="col-md-12 mb-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6 class="card-title">Mileage (km/L)</h6>
                <canvas id="mileageChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6 class="card-title">Spending per Refill (â‚¹)</h6>
                <canvas id="spendingChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6 class="card-title">Liters Filled</h6>
                <canvas id="litersChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzVAk_DfEc-07HJ5wTcBLErOwsmgvJlI0eCAyRoLqKNOkSDba6Wx6_fp2Z8sXbAGXDBtA/exec";

    // Submit form
    document.getElementById("fuelForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        date: formData.get("date"),
        odometer: parseFloat(formData.get("odometer")),
        liters: parseFloat(formData.get("liters")),
        price_per_liter: parseFloat(formData.get("price")),
        total_cost: parseFloat(formData.get("liters")) * parseFloat(formData.get("price")),
        station: formData.get("station"),
        notes: formData.get("notes")
      };

      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      });

      loadLogs();
      e.target.reset();
    });

    // Fetch logs and update UI
    async function loadLogs() {
      const res = await fetch(API_URL);
      let logs = await res.json();
      
      logs.sort((a, b) => new Date(a.Date) - new Date(b.Date));

      // Show logs
      const container = document.getElementById("logsList");
      container.innerHTML = "";
      logs.slice().reverse().forEach(log => {
        const div = document.createElement("div");
        div.className = "col-md-6";
        div.innerHTML = `
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <h6>${log.Date} - ${log.Station || "Unknown"}</h6>
              <p class="mb-1">Odo: <b>${log.Odometer} km</b></p>
              <p class="mb-1">${log.Liters} L @ â‚¹${log["Price/L"]} = <b>â‚¹${log["Total Cost"]}</b></p>
              <small class="text-muted">${log.Notes || "-"}</small>
            </div>
          </div>
        `;
        container.appendChild(div);
      });

      updateCharts(logs);
    }

    // Update Charts
    function updateCharts(logs) {
      const labels = logs.map(l => l.Date);
      const odometers = logs.map(l => parseFloat(l.Odometer));
      const liters = logs.map(l => parseFloat(l.Liters));
      const costs = logs.map(l => parseFloat(l["Total Cost"]));

      // Mileage calculation
      let mileage = [];
      for (let i = 1; i < logs.length; i++) {
        const kmDiff = odometers[i] - odometers[i-1];
        const litersUsed = liters[i];
        mileage.push((kmDiff / litersUsed).toFixed(2));
      }
      let mileageLabels = labels.slice(1);

      // Destroy old charts
      if (window.mileageChartObj) window.mileageChartObj.destroy();
      if (window.spendingChartObj) window.spendingChartObj.destroy();
      if (window.litersChartObj) window.litersChartObj.destroy();

      // Mileage chart
      window.mileageChartObj = new Chart(document.getElementById("mileageChart"), {
        type: "line",
        data: { labels: mileageLabels, datasets: [{ label: "Mileage (km/L)", data: mileage, borderColor: "green", tension: 0.2 }] }
      });

      // Spending chart
      window.spendingChartObj = new Chart(document.getElementById("spendingChart"), {
        type: "bar",
        data: { labels: labels, datasets: [{ label: "Total Cost (â‚¹)", data: costs, backgroundColor: "blue" }] }
      });

      // Liters chart
      window.litersChartObj = new Chart(document.getElementById("litersChart"), {
        type: "bar",
        data: { labels: labels, datasets: [{ label: "Liters", data: liters, backgroundColor: "orange" }] }
      });
    }

    loadLogs();
  </script>
</body>
</html>
