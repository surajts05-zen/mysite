<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Morse Code ‚Äî Fun 2 Learn (Kids)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#2563eb" />
  <style>
    /* New styles for the custom modal */
    #modalOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}
    #modalContent{background:white;border-radius:12px;padding:20px;max-width:400px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,0.2);animation:modal-open 0.15s ease-out}
    @keyframes modal-open{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
    
    /* Existing styles */
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:#f0f4f8;margin:0;padding:1rem;display:flex;justify-content:center}
    .main{max-width:900px;width:100%;background:white;border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.08)}
    h1{font-size:1.75rem;margin:0 0 8px;color:#1f2937}
    .progress-container{width:100%;background:#e6eef8;border-radius:999px;height:14px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,#4f46e5,#06b6d4);width:0%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:11px}
    .hidden{display:none}
    .answer-button{background:#eef2ff;border-radius:10px;padding:10px;text-align:left;border:none;width:100%;cursor:pointer;transition:background 0.1s}
    .answer-button:hover:not(:disabled){background:#e0e7ff}
    .answer-button.correct{background:#16a34a;color:white}
    .answer-button.incorrect{background:#ef4444;color:white}
    .nav-button{background:#2563eb;color:white;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;transition:background 0.1s}
    .nav-button:hover{background:#1e40af}
    .reward{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#f59e0b,#f97316);color:white;font-weight:700}
    .morse-dot{width:12px;height:12px;border-radius:50%;background:#111827;display:inline-block;margin-right:6px}
    .morse-dash{display:inline-block;width:36px;height:12px;background:#111827;border-radius:6px;margin-right:6px}
    .card{background:#ffffff;border-radius:10px;padding:12px;box-shadow:0 4px 12px rgba(2,6,23,0.06)}
    @media (max-width:640px){ .grid-cols-3{grid-template-columns:repeat(2,1fr)} h1{font-size:1.4rem} }
  </style>
</head>
<body>
  <div class="main" id="appRoot">
    <h1>üì° Morse Code ‚Äî Fun 2 Learn (for kids)</h1>
    <p style="margin:6px 0 12px;color:#374151">Restored UI (from your Tamil app). PDFs removed ‚Äî content converted into gamified lessons. Use tabs below to study, practice, take quizzes and track progress.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <button class="nav-button" id="tabStudy">Study</button>
      <button class="nav-button" id="tabPractice">Practice</button>
      <button class="nav-button" id="tabQuiz">Quizzes</button>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div>Progress: <span id="progressLabel">0 / 0</span></div>
      <div style="display:flex;gap:8px;align-items:center"><div id="streak">üî• Streak: 0</div><div class="reward" id="coinCount">‚≠ê 0</div></div>
    </div>
    <div class="progress-container mb-4"><div class="progress-bar" id="progressBar">0%</div></div>

    <!-- STUDY SECTION (REPLACES PDF) -->
    <div id="studySection" class="card">
      <h2 style="font-size:1.1rem;margin-bottom:6px">üìò Study ‚Äî Lessons from Study Manual</h2>
      <p style="color:#374151;margin-bottom:8px">I converted the Study-Manual-General-Grade-22.pdf into bite-sized lessons. Each lesson has narration, micro-activities and a mini-quiz.</p>
      <div id="lessonsList"></div>
    </div>

    <!-- PRACTICE SECTION -->
    <div id="practiceSection" class="card hidden" style="margin-top:12px">
      <h2 style="font-size:1.1rem;margin-bottom:6px">üéß Practice ‚Äî Hear & Send</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
        <select id="practiceLetter" style="padding:8px;border-radius:8px"></select>
        <button class="nav-button" id="playMorseBtn">Play Morse</button>
        <button class="nav-button" id="playSlowBtn">Play Slow</button>
        <button class="nav-button" id="openSend">Open Send Practice</button>
      </div>
      <div id="morseVisual"></div>
    </div>

    <!-- QUIZ SECTION -->
    <div id="quizSection" class="card hidden" style="margin-top:12px">
      <h2 style="font-size:1.1rem;margin-bottom:6px">üß© Quizzes (ASOC question bank)</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
        <button class="nav-button" id="btnRules">Rules & Regulations</button>
        <button class="nav-button" id="btnElec">Basic Electronics</button>
        <label style="margin-left:6px">Max questions:</label>
        <input id="maxQuestions" type="number" min="1" max="200" value="10" style="width:80px;padding:6px;border-radius:6px;border:1px solid #e5e7eb" />
        <label style="margin-left:12px">Mode:</label>
        <select id="quizMode" style="padding:6px;border-radius:6px">
            <option value="practice">Practice (instant feedback)</option>
            <option value="exam">Exam (timed)</option>
        </select>
      </div>
      <div id="quizSetup">
        Choose quiz and start.
        <!-- The Start button is now explicitly in HTML -->
        <button class="nav-button mt-4" id="startQuizBtn">Start Quiz</button>
      </div>
      <div id="quizPlay" class="hidden" style="margin-top:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>Q <span id="currentQ">0</span> / <span id="totalQ">0</span></div>
          <div>Score: <strong id="score">0</strong></div>
        </div>
        <div style="padding:12px;border-radius:10px;background:#f8fafc;margin-bottom:8px">
          <div id="questionText" style="font-size:1.05rem;font-weight:600"></div>
        </div>
        <div id="answersGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        <div id="feedback" style="margin-top:8px;font-weight:700"></div>
        <div style="display:flex;gap:8px;margin-top:12px"><button class="nav-button" id="nextBtn">Next</button><button class="nav-button" id="quitBtn">Quit</button></div>
      </div>
    </div>

    <hr style="margin:18px 0" />
    <div style="font-size:13px;color:#6b7280">Suggestions: daily 15‚Äì20 minute lessons, flashcards, hands-on oscillator project and parent dashboard for tracking. (Study Manual content used to generate lessons).</div>
  </div>

  <!-- CUSTOM MODAL HTML (Replaces alert/confirm) -->
  <div id="modalOverlay" class="hidden">
    <div id="modalContent">
      <div id="modalTitle" class="text-xl font-semibold text-gray-800 mb-2"></div>
      <div id="modalText" class="text-gray-600 mb-4"></div>
      <div id="modalFooter" class="flex justify-end pt-3 gap-2">
        <!-- Buttons added dynamically by JS -->
      </div>
    </div>
  </div>

<script>
(function() { // START IIFE WRAPPER

// ---------------------- CUSTOM MODAL IMPLEMENTATION ----------------------
const modalOverlay = document.getElementById('modalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalText = document.getElementById('modalText');
const modalFooter = document.getElementById('modalFooter');

// Utility to create a button element
function createButton(text, className, action) {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.className = 'px-4 py-2 rounded-lg font-medium transition-colors ' + className;
    btn.onclick = () => {
        modalOverlay.classList.add('hidden');
        if (action) action();
    };
    return btn;
}

/** Replaces standard alert(). Shows a message and an OK button. */
function showModal(title, message) {
    modalTitle.textContent = title;
    modalText.textContent = message;
    modalFooter.innerHTML = '';
    
    const okBtn = createButton('OK', 'bg-blue-600 text-white hover:bg-blue-700');
    modalFooter.appendChild(okBtn);

    modalOverlay.classList.remove('hidden');
}

/** Replaces standard confirm(). Shows a message with Confirm/Cancel buttons. */
function showConfirmation(title, message, onConfirm, onCancel = null) {
    modalTitle.textContent = title;
    modalText.textContent = message;
    modalFooter.innerHTML = '';

    const cancelBtn = createButton('Cancel', 'bg-gray-200 text-gray-700 hover:bg-gray-300', onCancel);
    const confirmBtn = createButton('Confirm', 'bg-red-600 text-white hover:bg-red-700', onConfirm);

    modalFooter.appendChild(cancelBtn);
    modalFooter.appendChild(confirmBtn);

    modalOverlay.classList.remove('hidden');
}

// ---------------------- DATA IMPORTED FROM UPLOADED FILES (Now EMPTY) ----------------------
// Note: Quiz banks are currently empty. A placeholder will be displayed when starting a quiz.
const rulesBank = []; 
const electronicsBank = []; 

// ---------------------- APP STATE ----------------------
let state = {currentSet:[],currentIndex:0,total:0,score:0,coins:0,streak:0}; 
// State for sequential lesson quiz
let miniQuizState = { correct: 0, lesson: null, step: 0 };

// UI elements (reduced for brevity)
const studySection = document.getElementById('studySection');
const practiceSection = document.getElementById('practiceSection');
const quizSection = document.getElementById('quizSection');
const lessonsList = document.getElementById('lessonsList');
const practiceLetter = document.getElementById('practiceLetter');
const playMorseBtn = document.getElementById('playMorseBtn');
const playSlowBtn = document.getElementById('playSlowBtn');
const openSend = document.getElementById('openSend');
const btnRules = document.getElementById('btnRules');
const btnElec = document.getElementById('btnElec');
const startQuizBtn = document.getElementById('startQuizBtn'); 
const quizPlay = document.getElementById('quizPlay');
const quizSetup = document.getElementById('quizSetup');
const questionText = document.getElementById('questionText');
const answersGrid = document.getElementById('answersGrid');
const currentQ = document.getElementById('currentQ');
const totalQ = document.getElementById('totalQ');
const scoreEl = document.getElementById('score');
const progressBar = document.getElementById('progressBar');
const progressLabel = document.getElementById('progressLabel');
const coinCount = document.getElementById('coinCount');
const streakEl = document.getElementById('streak');

// Tab buttons
document.getElementById('tabStudy').onclick = ()=>{studySection.scrollIntoView({behavior:'smooth'}); studySection.classList.remove('hidden'); practiceSection.classList.add('hidden'); quizSection.classList.add('hidden');};
document.getElementById('tabPractice').onclick = ()=>{practiceSection.classList.remove('hidden'); studySection.classList.add('hidden'); quizSection.classList.add('hidden');};
document.getElementById('tabQuiz').onclick = ()=>{quizSection.classList.remove('hidden'); studySection.classList.add('hidden'); practiceSection.classList.add('hidden');};

// ---------------------- LESSONS & MINI QUIZ (SEQUENTIAL FLOW) ----------------------
const lessons = [
  {id:'m1',title:'Intro to Amateur Radio & Safety',questions:[
    {q:'Is a dash 3 times the length of a dot?', correct: true},
    {q:'Should you identify at the start and end of contact?', correct: true},
    {q:'Ohm\'s law is V = I x R?', correct: true}
  ],text:`Amateur radio helps people communicate across distances. You'll learn about callsigns, safety, and why radio is useful in emergencies. Key points: always keep the key at earth potential, log your contacts, and follow operator rules.`},
  {id:'m2',title:'Morse Basics ‚Äî Dots & Dashes',text:`Dot = 1 unit, Dash = 3 units. Space between elements = 1 unit, between letters = 3 units, between words = 5 units. Learn the rhythm first ‚Äî think of music rhythm.`},
  {id:'m3',title:'Operating Procedures',text:`Identify at the start and end of contacts. Use phonetics for clarity. During emergencies use any mode necessary. Keep CQ short and polite.`},
  {id:'m4',title:'Basic Electronics (kid-friendly)',text:`Voltage pushes current; current is the flow; resistance slows it. Ohm's law: V = I √ó R. Batteries, resistors, capacitors and simple circuits are explained with hands-on projects.`},
  {id:'m5',title:'Practice Oscillator & Sending',text:`A simple code practice oscillator (CPO) produces a tone (800‚Äì1000 Hz). Practice sending from the wrist and keep the key at earth potential. Build a small CPO for classroom practice.`}
]; 

function renderLessons(){ 
  lessonsList.innerHTML=''; 
  lessons.forEach(ls=>{ 
    const d=document.createElement('div'); 
    d.className='card'; 
    d.style.marginBottom='8px'; 
    d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${ls.title}</strong><div style="color:#374151;font-size:13px">${ls.text}</div></div><div><button class='nav-button' data-id='${ls.id}'>Start</button></div></div>`; 
    lessonsList.appendChild(d); 
  });
  // attach start listeners
  document.querySelectorAll('#lessonsList .nav-button').forEach(b=>b.onclick=(e)=>{ 
    const id=e.target.dataset.id; 
    startLesson(id); 
  });
}

function startLesson(id) { 
  const l = lessons.find(x => x.id === id); 
  if (!l) return; 

  // Reset quiz state and set initial step
  miniQuizState = { correct: 0, lesson: l, step: 0 };

  // Show Lesson Info Modal
  showModal(`Lesson: ${l.title}`, 
    `${l.text}<br><br>Complete the mini-quiz (if available) to earn coins.`
  );
  
  if (l.questions && l.questions.length > 0) {
      setTimeout(() => {
          miniQuizState.step = 1; // Start with the first question
          askMiniQuizQuestion();
      }, 300); // Delay slightly so the info modal can be read before quiz starts
  }
}

function askMiniQuizQuestion() {
    const l = miniQuizState.lesson;
    const currentQIndex = miniQuizState.step - 1;

    if (currentQIndex < l.questions.length) {
        const qItem = l.questions[currentQIndex];
        const isTrueFalse = qItem.q.endsWith('?'); // Simple heuristic for Q&A

        if (isTrueFalse) {
            showConfirmation(
                `Mini-Quiz (${miniQuizState.step}/${l.questions.length})`, 
                qItem.q, 
                () => handleMiniQuizAnswer(true), // Confirm/Yes
                () => handleMiniQuizAnswer(false)  // Cancel/No
            );
        } else {
            // For general questions, just show a message until we get more robust Q&A structures
            handleMiniQuizAnswer(qItem.correct); // Auto-correct for simplicity until a proper question structure is provided
        }
    } else {
        // Quiz finished
        const earned = miniQuizState.correct * 5; 
        state.coins += earned; 
        state.streak++; 
        coinCount.textContent = `‚≠ê ${state.coins}`; 
        streakEl.textContent = `üî• Streak: ${state.streak}`; 
        updateProgress(); 
        showModal('Lesson Complete!', `Mini-Quiz finished. You got ${miniQuizState.correct} correct and earned ${earned} coins!`);
    }
}

function handleMiniQuizAnswer(isCorrect) {
    if (isCorrect) miniQuizState.correct++;
    miniQuizState.step++;
    // Continue sequence or finish
    askMiniQuizQuestion(); 
}


// ---------------------- PRACTICE (Morse play) ----------------------
for(const ch of ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','1','2','3','4','5','6','7','8','9','0']){
  const o=document.createElement('option'); o.value=ch; o.textContent=ch; practiceLetter.appendChild(o);
}
const audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 

function playMorseSequence(code,wpm=18){ 
    const dot = 1.2/wpm; 
    const dash = dot*3; 
    let t=audioCtx.currentTime; 
    const osc=audioCtx.createOscillator(); 
    const g=audioCtx.createGain(); 
    osc.type='sine'; 
    osc.frequency.value=900; 
    osc.connect(g); 
    g.connect(audioCtx.destination); 
    g.gain.setValueAtTime(0,t); 
    osc.start(); 
    const viz=document.getElementById('morseVisual'); 
    viz.innerHTML=''; 
    for(const c of code){ 
        if(c==='.') { 
            g.gain.setValueAtTime(1,t); 
            t+=dot; 
            g.gain.setValueAtTime(0,t); 
            t+=dot; 
            viz.innerHTML += '<span class="morse-dot"></span>'; 
        } else if(c==='-'){ 
            g.gain.setValueAtTime(1,t); 
            t+=dash; 
            g.gain.setValueAtTime(0,t); 
            t+=dot; 
            viz.innerHTML += '<span class="morse-dash"></span>'; 
        } 
    }
    osc.stop(t+0.05);
}

playMorseBtn.onclick = ()=>{ const c = practiceLetter.value; const code = mapMorse(c); playMorseSequence(code,20); };
playSlowBtn.onclick = ()=>{ const c = practiceLetter.value; const code = mapMorse(c); playMorseSequence(code,12); };
openSend.onclick = ()=>{ openSendPractice(); };

function mapMorse(ch){ const map = {A:'.-',B:'-...',C:'-.-.',D:'-..',E:'.',F:'..-.',G:'--.',H:'....',I:'..',J:'.---',K:'-.-',L:'.-..',M:'--',N:'-.',O:'---',P:'.--.',Q:'--.-',R:'.-.',S:'...',T:'-',U:'..-',V:'...-',W:'.--',X:'-..-',Y:'-.--',Z:'--..',1:'.----',2:'..---',3:'...--',4:'....-',5:'.....',6:'-....',7:'--...',8:'---..',9:'----.',0:'-----'}; return map[ch]||''; }

function openSendPractice(){ // simple tap-based sender
  const w = window.open('','sendPractice','width=420,height=680');
  // NOTE: This embedded script is single-line to prevent parser issues on some environments.
  w.document.write(`<html><head><title>Send Practice</title><style>body{font-family:Arial;padding:10px}button{padding:20px;font-size:16px;border-radius:8px}#out{font-size:24px;margin-top:12px}</style></head><body><h3>Tap to send (press & hold for dash)</h3><button id='pad'>Hold / Tap</button><div id='out'></div><script>let start;const out=document.getElementById('out');document.getElementById('pad').addEventListener('mousedown',e=>start=Date.now());document.getElementById('pad').addEventListener('mouseup',e=>{const d=Date.now()-start; out.textContent += (d>200?'-':'.');});document.addEventListener('keydown',e=>{ if(e.code==='Space'){start=Date.now();} });document.addEventListener('keyup',e=>{ if(e.code==='Space'){const d=Date.now()-start; out.textContent += (d>200?'-':'.');} });</script></body></html>`);
}

// ---------------------- QUIZ ENGINE ----------------------
function openQuizBank(bank){ 
  quizPlay.classList.add('hidden'); 
  quizSetup.classList.remove('hidden'); 
  quizSection.dataset.type = bank; 
  document.getElementById('quizSetup').innerHTML = `Ready: ${bank} quiz ‚Äî choose max questions and mode, then Start. <button class="nav-button mt-4" id="startQuizBtn">Start Quiz</button>`; 
  // Re-attach listener for the dynamically created start button
  document.getElementById('startQuizBtn').addEventListener('click', startQuizFromButton);
}

btnRules.onclick = ()=>openQuizBank('rules'); 
btnElec.onclick = ()=>openQuizBank('electronics');

document.getElementById('maxQuestions').value = 10;

function startQuizFromButton(){ 
  const type = quizSection.dataset.type || 'rules'; 
  const max = parseInt(document.getElementById('maxQuestions').value)||10; 
  let bank = (type==='rules')? [...rulesBank] : [...electronicsBank]; 
  
  if (bank.length === 0) {
      showModal('No Questions', 'The question bank for this category is currently empty. Please check back later!');
      return;
  }
  
  shuffle(bank); 
  const pick = bank.slice(0,Math.min(max,bank.length)); 
  state.currentSet = pick; 
  state.currentIndex = 0; 
  state.total = pick.length; 
  state.score = 0; 
  totalQ.textContent = state.total; 
  currentQ.textContent = 0; 
  scoreEl.textContent = 0; 
  quizSetup.classList.add('hidden'); 
  quizPlay.classList.remove('hidden'); 
  renderQuestion(); 
  updateProgress(); 
}

function renderQuestion(){ 
  if(state.currentIndex >= state.total){ 
    finishQuiz(); 
    return;
  } 
  
  const item = state.currentSet[state.currentIndex]; 
  currentQ.textContent = state.currentIndex+1; 
  questionText.textContent = item.q; 
  answersGrid.innerHTML=''; 
  item.a.forEach((opt,idx)=>{ 
    const b=document.createElement('button'); 
    b.className='answer-button'; 
    b.textContent=opt; 
    b.onclick=()=>selectAnswer(idx); 
    answersGrid.appendChild(b); 
  }); 
}

function selectAnswer(idx){ 
  const item = state.currentSet[state.currentIndex]; 
  const buttons = Array.from(answersGrid.children); 
  buttons.forEach(b=>{b.disabled=true}); 
  
  if(idx===item.correct){ 
    buttons[idx].classList.add('correct'); 
    state.score++; 
    state.coins+=5; 
    scoreEl.textContent = state.score; 
    coinCount.textContent = `‚≠ê ${state.coins}`; 
    document.getElementById('feedback').textContent='Correct! +5 coins'; 
  } else { 
    buttons[idx].classList.add('incorrect'); 
    buttons[item.correct].classList.add('correct'); 
    state.coins+=1; 
    coinCount.textContent = `‚≠ê ${state.coins}`; 
    document.getElementById('feedback').textContent='Not quite ‚Äî review the lesson and try again.'; 
  }
}

document.getElementById('nextBtn').onclick = ()=>{ 
  state.currentIndex++; 
  document.getElementById('feedback').textContent=''; 
  renderQuestion(); 
  updateProgress(); 
}; 

document.getElementById('quitBtn').onclick = ()=>{ 
  // Use non-blocking showConfirmation instead of confirm()
  showConfirmation(
    'Quit Quiz?', 
    'Are you sure you want to quit the current quiz? Your score will be saved, but coins for unattempted questions will be lost.',
    ()=>{ // On Confirm
      quizPlay.classList.add('hidden'); 
      quizSetup.classList.remove('hidden');
    }
  );
}; 

function finishQuiz(){ 
  quizPlay.classList.add('hidden'); 
  quizSetup.classList.remove('hidden'); 
  // Use non-blocking showModal instead of alert()
  showModal(
    'Quiz Complete!', 
    `You finished the quiz! Final Score: ${state.score} / ${state.total}. You earned ${state.coins} total coins!`
  );
}

function updateProgress(){ 
  const done = state.currentIndex; 
  const total = state.total || 1; 
  const pct = Math.round((done/total)*100); 
  progressBar.style.width = pct + '%'; 
  progressBar.textContent = pct + '%'; 
  progressLabel.textContent = `${done} / ${state.total}`; 
}

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

// ---------------------- Initialize ----------------------
document.getElementById('startQuizBtn').addEventListener('click', startQuizFromButton);

renderLessons();
updateProgress();
coinCount.textContent = `‚≠ê ${state.coins}`;
streakEl.textContent = `üî• Streak: ${state.streak}`;

})(); // END IIFE WRAPPER
</script>
</body>
</html>
